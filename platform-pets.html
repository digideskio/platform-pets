<!--
	Pet Platformers Game

	Author: John and Abdullah
	Copyright (c) 2015 Altspace VR
-->
<!DOCTYPE html>
<html lang="en">
<head>
		<title>Pets Platformer</title>
		
		<script src="AltspaceSDK/lib/three.js"></script>
		<!-- Required by OBJMTLLoader.js -->
		<script src="AltspaceSDK/src/AltOBJMTLLoader.js"></script>
		<script src="AltspaceSDK/lib/firebase.js"></script>

		<script src="AltspaceSDK/src/cursor/CursorEvents.js"></script>
		<script src="AltspaceSDK/src/cursor/AltObjectControls.js"></script>
		<script src="AltspaceSDK/src/sync/FirebaseSync.js"></script>

		<script src="AltspaceSDK/src/cursor/ColorHoverEffect.js"></script>
		<script src="AltspaceSDK/src/cursor/DragPlaneEffect.js"></script>
		
		<!-- keyboard events -->
		<!--<script src="threex.keyboardstate.js"></script>-->
		<!-- physics -->
		<script type="text/javascript" src="Physijs/physi.js"></script>
		<script type="text/javascript" src="Physijs/examples/js/stats.js"></script>
		
	

		<style>
			body {
				background-color: rgba(0, 0, 0, 0);
				color: 0xffffff;
				font-family: Monospace;
				margin: 0px;
				overflow: hidden;
				font-size: 18px;
				text-align: center;
			}
			#info {
				position: absolute;
				top: 0px;
				width: 100%;
				padding: 10px;
			}
		</style>

</head>
<body>
<body>
		<div id="info">
		</div>
		<div id="viewport"></div>
</body>

<script>
Physijs.scripts.worker = 'Physijs/physijs_worker.js';
Physijs.scripts.ammo = 'examples/js/ammo.js';

var inAltspace = window.hasOwnProperty('altspace');

var scene, camera, renderer, altRenderer;
var cursorEvents, firebaseSync;
var loader;
var sound;

//var keyboard;

var render_stats, physics_stats;
var box_material, ground_material, ground, boxes=[];

var prevTimestamp = 0;
var perlin2D;

loadModels();

function loadModels() {

	var loader = new THREE.AltOBJMTLLoader();

	// loader assumes .mtl file has same basename as .obj file
	// var objFilename = "AltspaceSDK/examples/models/AltspaceCube/cube.obj";
	// loader.load(objFilename, function ( loadedObject ) {
	// 	onModelsLoaded();
	// });
	onModelsLoaded();
	// NO CODE HERE unless you want it to run before models finish loading.
}

function onModelsLoaded() {

	initScene();
	initSync();
	
	//keyboard = new THREEx.KeyboardState();
	
	// Materials
	ground_material = Physijs.createMaterial(
		new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'Physijs/examples/images/rocks.jpg' ) }),
		.8, // high friction
		.4 // low restitution
	);
	ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
	ground_material.map.repeat.set( 3, 3 );
	
	box_material = Physijs.createMaterial(
		new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'Physijs/examples/images/plywood.jpg' ) }),
		.4, // low friction
		.6 // high restitution
	);
	box_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
	box_material.map.repeat.set( .25, .25 );
	
	// Ground
	ground = new Physijs.BoxMesh(
		new THREE.BoxGeometry(1000, 1, 1000),
		ground_material,
		0 // mass
	);
	ground.receiveShadow = true;
	ground.position.set(0, 0, -500);
	scene.add( ground );
	
	box = new Physijs.BoxMesh(
		new THREE.BoxGeometry( 4, 4, 4 ),
		box_material
	);
	box.position.set(
		1,200,-250//Math.random() * 50 - 25,
		//10 + Math.random() * 5,
		//Math.random() * 50 - 25
	);
	box.rotation.set(
		Math.random() * Math.PI * 2,
		Math.random() * Math.PI * 2,
		Math.random() * Math.PI * 2
	);
	box.scale.set(
		30,30,30//Math.random() * 1 + .5,
		//Math.random() * 1 + .5,
		//Math.random() * 1 + .5
	);
	box.castShadow = true;
	scene.add( box );
	boxes.push( box );
}

function onSyncReady() {

	initEvents();
	animate(prevTimestamp);

}

function applyForce()
{
	var effect, offset, box;
	
	var force = new THREE.Vector3(0,0,0);
	var zoom = 300;
	//if (keyboard.pressed("i")){
	//	force.z = -zoom;
	//}
	//if (keyboard.pressed("k")){
	//	force.z = zoom;
	//}
	//if (keyboard.pressed("j")){
	//	force.x = -zoom;
	//}
	//if (keyboard.pressed("l")){
	//	force.x = zoom;
	//}
	//if (keyboard.pressed("f")){
	//	force.y = zoom*10;
	//}
	
	for ( var i = 0; i < boxes.length; i++ ) {
		box = boxes[i];
		effect = force;
		offset = new THREE.Vector3(0,0,0);
		box.applyImpulse( effect, offset );
	}
}

function initScene() {

    // default scene
	//scene = new THREE.Scene();
	
	
	render_stats = new Stats();
	render_stats.domElement.style.position = 'absolute';
	render_stats.domElement.style.top = '1px';
	render_stats.domElement.style.zIndex = 100;
	document.getElementById( 'viewport' ).appendChild( render_stats.domElement );

	physics_stats = new Stats();
	physics_stats.domElement.style.position = 'absolute';
	physics_stats.domElement.style.top = '50px';
	physics_stats.domElement.style.zIndex = 100;
	document.getElementById( 'viewport' ).appendChild( physics_stats.domElement );
		
	// physijs scene
	scene = new Physijs.Scene;
	//TODO: get real gravity
	scene.setGravity(new THREE.Vector3( 0, -300, 0 ));
	scene.addEventListener(
		'update',
		function() {
			applyForce();
			scene.simulate( undefined, 1 );
			physics_stats.update();
		}
	);

	var container = document.createElement( 'div' );
	// container.style.visibility = "hidden";
	document.body.appendChild( container );
	if ( inAltspace ) {

		altRenderer = altspace.getThreeJSRenderer({version: '0.2.0'});
		// hide any elements on webpage
		document.getElementById("info").style.visibility = "hidden";

		// Place the cube at the bottom of the enclosure.
		scene.position.y = ( -1 * window.innerHeight / 2 );

	}// else {

		renderer = new THREE.WebGLRenderer( { antialias: true } );
		// renderer.setPixelRatio( window.devicePixelRatio );
		renderer.setSize( window.innerWidth, window.innerHeight );
		container.appendChild( renderer.domElement );

		var aspect = window.innerWidth / window.innerHeight;
		camera = new THREE.PerspectiveCamera( 70, aspect, 1, 1000 );
		camera.position.z = 400;
		camera.position.y = 300;
		camera.lookAt( scene.position );

		// OBJMTLLoader always uses PhongMaterial, so we need light in scene.
		var ambient = new THREE.AmbientLight( 0xffffff );
		scene.add( ambient );
		
		pointLight = new THREE.PointLight( 0xffffff, 1.75 );
		scene.add( pointLight );
	// }

}


function initEvents() {

	cursorEvents = new CursorEvents( scene );
	cursorEvents.enableMouseEvents( camera );

	// cursorEvents.addObject( cube );

	var playSound = function( event ) {
		if (!sound) loadSoundEffect();
		sound.play();
		console.log("playSound"); // For debugging, in case sound is muted.
	};

	// if ( inAltspace ) {
	// 	// TEMP until we implement bubbling, currently event fired on child mesh.
	// 	cube.children[0].addEventListener( "cursordown", playSound );
	// } else {
	// 	cube.addEventListener( "cursordown", playSound );
	// }

	// In addition to defining event listeners, you can apply pre-made effects
	// or create your own effects that work with the CursorEvents framework.

	var dragEffect = new DragPlaneEffect( { firebaseSync: firebaseSync });
	var hoverEffect = new ColorHoverEffect( { color: new THREE.Color(0, 1, 1) });
	// hover listens for cursorenter / cursorleave for hover over / out

	// cursorEvents.addEffect( dragEffect, cube );
	// cursorEvents.addEffect( hoverEffect, cube );
	window.addEventListener( 'resize', onWindowResize, false );
	document.addEventListener("keydown", function(e){
			console.log("hello world");
	}, false);

}

function initSync() {

	var firebaseRootUrl = "https://altspace-apps.firebaseio.com/";
	var appId = "spinning-cube";

	var params = { authTokenPath: "AltspaceSDK/examples/tokens/spinning-cube-token.txt" };

	firebaseSync = new FirebaseSync( firebaseRootUrl, appId, params );

	// firebaseSync.addObject( cube, "cube" );
	firebaseSync.connect( onSyncReady );

}

function loadSoundEffect() {

	// Load sound effect. Chromium doesn't support mp3 so include wav too.
	var ext = (new Audio()).canPlayType('audio/mpeg') ? ".mp3" : ".wav";
	sound = new Audio("sounds/drippy" + ext);	

}

function onWindowResize() {

	if ( inAltspace ) return ; // Resize not supported yet.

	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize( window.innerWidth, window.innerHeight );

}

function animate( timestamp ) {
	var frameTime = ( timestamp - prevTimestamp ) * 0.001;
	prevTimestamp = timestamp;

    var moveSpeed = 5.0;
	cursorEvents.update();

	if(inAltspace)
		altRenderer.render(scene, camera);
	else
		renderer.render( scene, camera );

	scene.simulate();
	render_stats.update();
	requestAnimationFrame( animate );
}

</script>
</body>
</html>